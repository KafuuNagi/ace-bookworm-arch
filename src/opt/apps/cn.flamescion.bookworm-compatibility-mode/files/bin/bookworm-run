#!/bin/bash
if [ ! -e /opt/apps/cn.flamescion.bookworm-compatibility-mode/files/bookworm-env/finish.flag ];then

if [ "$(id -u)" = "0" ]; then
    /opt/apps/cn.flamescion.bookworm-compatibility-mode/files/bin/bookworm-init
else
pkexec /opt/apps/cn.flamescion.bookworm-compatibility-mode/files/bin/bookworm-init
fi


fi
if [ "$1" = "" ];then
cmd=bash
else


			# container_command=$*
			cmd="$1"
			shift
			for arg in "$@"; do
if [[ $arg =~ \  ]]; then
    arg=\'${arg//\'/\'\\\'\'}\'
fi
				OPTIONS="${OPTIONS} ${arg}"
			done

echo -----------------------
echo ${cmd} ${OPTIONS}
echo -----------------------


fi
chrootEnvPath=/opt/apps/cn.flamescion.bookworm-compatibility-mode/files/bookworm-env
non_root_user=$(who  | awk '{print $1}' | head -n 1)
uid=$(id -u $non_root_user)


bwrap --dev-bind $chrootEnvPath/ / \
  --setenv LANG "$LANG" \
  --setenv LC_COLLATE "$LC_COLLATE" \
  --setenv LC_CTYPE "$LC_CTYPE" \
  --setenv LC_MONETARY "$LC_MONETARY" \
  --setenv LC_MESSAGES "$LC_MESSAGES" \
  --setenv LC_NUMERIC "$LC_NUMERIC" \
  --setenv LC_TIME "$LC_TIME" \
  --setenv LC_ALL "$LC_ALL" \
  --setenv PULSE_SERVER /run/user/$uid/pulse/native \
  --setenv PATH /flamescion-container-tools/bin-override:$PATH \
  --dev-bind $chrootEnvPath/ / \
  --dev-bind /media /media \
  --dev-bind /tmp /tmp \
  --dev /dev  \
  --proc /proc  \
  --dev-bind /sys /sys  \
  --dev-bind /run /run  \
  --dev-bind /run/user/$uid/pulse /run/user/$uid/pulse  \
  --dev-bind / /run/host \
  --hostname bookworm-compatibility-mode \
  --unshare-uts \
  --bind /etc/passwd /etc/passwd \
  --dev-bind /etc/resolv.conf /etc/resolv.conf \
  --dev-bind /home /home \
  bash -c "${cmd} ${OPTIONS}"



