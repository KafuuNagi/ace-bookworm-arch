#!/bin/bash
if [ ! -e /opt/apps/store.spark-app.bookworm-compatibility-mode/files/bookworm-env/finish.flag ];then

if [ "$(id -u)" = "0" ]; then
    /opt/apps/store.spark-app.bookworm-compatibility-mode/files/bin/bookworm-init
else
pkexec /opt/apps/store.spark-app.bookworm-compatibility-mode/files/bin/bookworm-init
fi


fi
if [ "$1" = "" ];then
OPTIONS="bash"
else
OPTIONS="$@"
fi
chrootEnvPath=/opt/apps/store.spark-app.bookworm-compatibility-mode/files/bookworm-env
non_root_user=$(who  | awk '{print $1}' | head -n 1)
uid=$(id -u $non_root_user)


bwrap --dev-bind $chrootEnvPath/ / \
  --setenv LANG "$LANG" \
  --setenv LC_COLLATE "$LC_COLLATE" \
  --setenv LC_CTYPE "$LC_CTYPE" \
  --setenv LC_MONETARY "$LC_MONETARY" \
  --setenv LC_MESSAGES "$LC_MESSAGES" \
  --setenv LC_NUMERIC "$LC_NUMERIC" \
  --setenv LC_TIME "$LC_TIME" \
  --setenv LC_ALL "$LC_ALL" \
  --setenv PULSE_SERVER /run/user/$uid/pulse/native \
  --dev-bind $chrootEnvPath/etc /etc \
  --dev-bind $chrootEnvPath/opt /opt \
  --dev-bind $chrootEnvPath/usr /usr \
  --dev-bind /media /media \
  --dev /dev  \
  --proc /proc  \
  --dev-bind /run/user/$uid/pulse /run/user/$uid/pulse  \
  --dev-bind $chrootEnvPath/var /var \
  --dev-bind / /run/host \
  --hostname bookworm-compatibility-mode \
  --unshare-uts \
  --bind /etc/passwd /etc/passwd \
  --dev-bind /etc/resolv.conf /etc/resolv.conf \
  --dev-bind /home /home \
  $OPTIONS



